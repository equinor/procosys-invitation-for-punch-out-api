name: Build and Push Docker Image
description: 'Build and push Docker image to Azure Container Registry and returns its tag. If the image already exists, it will not be rebuilt.'

inputs:
  client-id:
    description: 'Identity client id'
    required: true
  tenant-id:
    description: 'Equinor tenant id'
    required: true

outputs:
  image-tag:
    description: 'Docker image tag'
    value: ${{ steps.create-tag-from-sha.outputs.image-tag }}

runs:
  using: 'composite'
  steps:
    - name: Create Docker tag from SHA
      id: create-tag-from-sha
      shell: bash
      run: |
        IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "Image tag: $IMAGE_TAG"

    - name: Login to Azure Container Registry
      shell: bash
      run: az acr login --name procosys

    ## TODO early return
    - name: Check if image already exists
      id: check-image-exists
      shell: bash
      run: |
        if az acr repository show --name procosys --image api:${{ steps.create-tag-from-sha.outputs.image-tag }}; then
          echo "Image already exists, skipping build."
          echo "IMAGE_EXISTS=true" >> $GITHUB_ENV

    - name: Get DevOps Token
      if: env.IMAGE_EXISTS != 'true'
      id: 'get-devops-token'
      uses: ./.github/actions/get-devops-token

    - name: Build and push Docker image
      if: env.IMAGE_EXISTS != 'true'
      uses: docker/build-push-action@v6
      with:
        context: ./src
        file: ./src/Equinor.ProCoSys.IPO.WebApi/Dockerfile
        push: true
        build-args: |
          FEED_ACCESSTOKEN=${{ steps.get-devops-token.outputs.token }}
          AZURE_CLIENT_ID=${{ inputs.client-id }}
          AZURE_TENANT_ID=${{ inputs.tenant-id }}
        tags: |
          procosys.azurecr.io/api/ipo/api:${{ steps.create-tag-from-sha.outputs.image-tag }}
          procosys.azurecr.io/api/ipo/api:latest
